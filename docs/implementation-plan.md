# Bristool 実装計画書

## 概要

本ドキュメントは、データベースに定義されているがUIが未実装の機能について、段階的な実装計画をまとめたものです。

## 現在の実装状況

### 実装済み機能
- ✅ 基本認証機能（サインアップ、サインイン、パスワードリセット）
- ✅ 排便記録のCRUD操作
- ✅ 保護者-ユーザー関係の部分実装（ダッシュボードでのユーザー選択）
- ✅ レスポンシブUI（shadcn/ui、TailwindCSS）

### データベース定義済みだが未実装の機能

#### 🔴 完全未実装の機能

1. **管理者向けUI** (`admin`)
2. **医療機関向けUI** (`medical_institution`)
3. **医療スタッフ向けUI** (`medical_staff`)
4. **アクセス許可管理システム**
5. **ユーザータイプ別認証フロー**
6. **プロフィール管理機能**

## 段階的実装計画

### Phase 1: 基盤機能の強化 (優先度：高)

**目標：** 現在の認証システムを拡張し、多様なユーザータイプに対応する基盤を構築

#### 1.1 ユーザータイプ選択機能
**期間：** 2-3日  
**概要：** サインアップ時にユーザータイプを選択できるようにする

**実装内容：**
- [ ] サインアップページにユーザータイプ選択UIを追加
- [ ] ユーザータイプに応じた各専用テーブルへの自動挿入処理
- [ ] `signUpAction` の拡張（各アカウントテーブルへのレコード作成）

**関連ファイル：**
- `/app/(auth-pages)/sign-up/page.tsx`
- `/app/actions.ts`

#### 1.2 プロフィール管理UI
**期間：** 3-4日  
**概要：** ユーザーが表示名やアバター画像を設定できる機能

**実装内容：**
- [ ] プロフィール編集ページの作成 (`/app/profile/page.tsx`)
- [ ] 表示名編集フォーム
- [ ] アバター画像アップロード機能（Supabase Storage使用）
- [ ] プロフィール更新用Server Action

**関連ファイル：**
- `/app/profile/page.tsx` (新規作成)
- `/app/actions.ts`
- `/components/profile/` (新規ディレクトリ)

#### 1.3 認証フローの拡張
**期間：** 2日  
**概要：** ユーザータイプに応じたログイン後のリダイレクト処理

**実装内容：**
- [ ] ユーザータイプ判定処理
- [ ] タイプ別リダイレクト処理
- [ ] ナビゲーションメニューのタイプ別表示

**関連ファイル：**
- `/app/actions.ts`
- `/components/header-auth.tsx`

### Phase 2: 医療機関連携機能 (優先度：中)

**目標：** 医療機関とユーザー間のデータ共有機能を実装

#### 2.1 医療機関アカウント機能
**期間：** 5-7日  
**概要：** 医療機関専用の登録・管理機能

**実装内容：**
- [ ] 医療機関専用サインアップフロー
- [ ] 医療機関情報登録フォーム（機関名設定）
- [ ] 医療機関向けダッシュボード
- [ ] 患者データへのアクセス申請機能

**関連ファイル：**
- `/app/(auth-pages)/sign-up-medical/page.tsx` (新規作成)
- `/app/medical-dashboard/page.tsx` (新規作成)
- `/app/actions.ts`

#### 2.2 アクセス許可管理システム
**期間：** 7-10日  
**概要：** ユーザーが医療機関にデータアクセス許可を与える機能

**実装内容：**
- [ ] アクセス許可設定ページ
- [ ] 医療機関からの許可申請機能
- [ ] 許可の承認・拒否・取り消し機能
- [ ] アクセス許可状況一覧表示
- [ ] 医療機関向け患者データ閲覧機能

**関連ファイル：**
- `/app/permissions/page.tsx` (新規作成)
- `/app/medical-dashboard/patients/page.tsx` (新規作成)
- `/app/actions.ts`
- `/components/permissions/` (新規ディレクトリ)

#### 2.3 医療スタッフ機能
**期間：** 4-5日  
**概要：** 医療スタッフアカウントと所属医療機関との関連付け

**実装内容：**
- [ ] 医療スタッフ専用サインアップフロー
- [ ] 所属医療機関との関連付け機能
- [ ] 医療スタッフ向けダッシュボード
- [ ] 担当患者データ管理機能

**関連ファイル：**
- `/app/(auth-pages)/sign-up-staff/page.tsx` (新規作成)
- `/app/staff-dashboard/page.tsx` (新規作成)
- `/app/actions.ts`

### Phase 3: 管理・運用機能 (優先度：低)

**目標：** システム管理者向けの運用・管理機能を実装

#### 3.1 管理者向けダッシュボード
**期間：** 7-10日  
**概要：** システム全体の管理・監視機能

**実装内容：**
- [ ] 管理者専用ダッシュボード
- [ ] 全ユーザー管理画面
- [ ] ユーザーアカウント管理（有効化・無効化）
- [ ] システム使用状況の監視
- [ ] データ分析・レポート機能

**関連ファイル：**
- `/app/admin/page.tsx` (新規作成)
- `/app/admin/users/page.tsx` (新規作成)
- `/app/admin/analytics/page.tsx` (新規作成)
- `/app/actions.ts`
- `/components/admin/` (新規ディレクトリ)

## 技術的考慮事項

### データベース関連
- **RLS（Row Level Security）の拡張**：各ユーザータイプに適した権限制御の実装
- **タイプミスの修正**：`medical_stafff_accounts` → `medical_staff_accounts`

### 認証・セキュリティ
- **Server Actions の拡張**：各ユーザータイプに対応したCRUD操作
- **権限チェック**：ページアクセス時のユーザータイプ検証
- **データアクセス制御**：医療機関-患者間のアクセス許可管理

### UI/UX
- **デザインシステムの一貫性**：既存のshadcn/uiベースを維持
- **レスポンシブ対応**：全新規ページでモバイル対応
- **日本語UI**：既存の日本語UIパターンを踏襲

### パフォーマンス
- **画像アップロード**：Supabase Storageの活用
- **データ取得の最適化**：必要な権限チェックによる性能への影響を最小化

## リスク管理

### 高リスク
- **データベーススキーマ変更**：本番環境での慎重な移行が必要
- **権限管理の複雑化**：多様なユーザータイプによるアクセス制御

### 中リスク
- **既存機能への影響**：認証フロー変更による既存ユーザーへの影響
- **医療データの取り扱い**：医療機関連携における法的要件の遵守

### 低リスク
- **UI実装の複雑度**：既存のコンポーネントライブラリ活用により軽減

## 成功指標

### Phase 1
- [ ] 全ユーザータイプでの新規登録が正常に動作
- [ ] プロフィール編集機能が完全に動作
- [ ] 既存機能に影響なし

### Phase 2
- [ ] 医療機関-患者間のデータ共有が正常に動作
- [ ] アクセス許可の申請・承認フローが完全に動作
- [ ] 医療スタッフが所属機関の患者データにアクセス可能

### Phase 3
- [ ] 管理者がシステム全体を管理可能
- [ ] ユーザー管理機能が完全に動作
- [ ] システム監視・分析機能が提供する有用な情報

## 次のステップ

1. **Phase 1の詳細設計**：ユーザータイプ選択UIの具体的な設計
2. **データベース移行計画**：本番環境での安全な移行手順の策定
3. **テスト計画**：各Phaseでの包括的なテスト戦略の立案

---

*最終更新: 2024年6月23日*
*作成者: Claude Code*